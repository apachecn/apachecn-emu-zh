# Game Boy æ¨¡æ‹Ÿå™¨:ç¼–å†™ Z80 åæ±‡ç¼–ç¨‹åº

> åŸæ–‡ï¼š<https://www.inspiredpython.com/course/game-boy-emulator/game-boy-emulator-writing-the-z80-disassembler>

æ­£å¦‚ä½ æ‰€è®°å¾—çš„ï¼ŒZ80 æ˜¯ä¸€ä¸ª 8 ä½ CPUï¼Œæœ‰ 16 ä½æŒ‡ä»¤å¯ä¾›é€‰æ‹©ï¼Œæ¯ä¸ªæŒ‡ä»¤éƒ½æœ‰ä¸€ä¸ªç›¸å…³çš„*æ“ä½œç *å’Œé›¶ä¸ªæˆ–å¤šä¸ªè¯¥æŒ‡ä»¤ä½¿ç”¨çš„*æ“ä½œæ•°*ã€‚

ç¨åï¼Œæˆ‘ä»¬å°†å®ç°æ¯æ¡æŒ‡ä»¤çš„ç»†èŠ‚ï¼Œä½†åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£æ¸¸æˆæœºå¦‚ä½•å°†ä¿¡æ¯ä¼ é€’ç»™ CPU è¿›è¡Œå¤„ç†ï¼›ä¸ºäº†ç†è§£è¿™ä¸€ç‚¹ï¼Œåœ¨ç»§ç»­ç¼–å†™æ¨¡æ‹Ÿå™¨çš„ç¬¬ä¸€éƒ¨åˆ†:åæ±‡ç¼–å™¨ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå¿«é€Ÿæµè§ˆä¸€ä¸‹ä»€ä¹ˆæ˜¯æ¥è‡ªçš„*æ’ä»¶ã€‚*



## ä»€ä¹ˆæ˜¯ Game Boy å¡å¸¦ ROMï¼Ÿ

[![alt](img/79142a4261cda6935d2f6deda4fe6bda.png)](https://www.inspiredpython.com/static/courses/game-boy-emulator/Game-Boy-Cartridge.jpg)

<figcaption>First-generation Game Boy Cartridge. The cartridge is slotted into the back of the Game Boy.</figcaption>



å½“ä½ æŠŠä¸€ä¸ªç›’å­æ”¾è¿›æ¸¸æˆæœºçš„èƒŒé¢æ—¶ï¼Œå®ƒä¼šä¸çŸ¥ä½•æ•…åœ°å¯åŠ¨ï¼Œå¹¶å¼€å§‹æ¸¸æˆã€‚Game Boy çš„å¡å¸¦å·®åˆ«å¾ˆå¤§ï¼Œè¿™å–å†³äºå®ƒæ˜¯ä¸ºå“ªç§æ¸¸æˆåˆ¶ä½œçš„ï¼Œå®ƒæ˜¯åœ¨å“ªä¸ªæ—¶ä»£åˆ¶ä½œçš„ï¼Œä»¥åŠå®ƒçš„å¼€å‘è€…æ˜¯è°ã€‚

å®ƒä»¬éƒ½æœ‰æŸç§å½¢å¼çš„æ¸¸æˆä»£ç å­˜å‚¨ã€‚ä¸€äº›è¾ƒå¤§çš„æ¸¸æˆæœ‰ä¸æ­¢ä¸€ä¸ªèŠ¯ç‰‡ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªå†…å­˜æ¡æ§åˆ¶å™¨ï¼Œå› ä¸º Game Boy åªæœ‰ä¸€ä¸ª 16 ä½*åœ°å€æ€»çº¿*ã€‚æ¸¸æˆå¯ä»¥æ ¹æ®éœ€è¦åœ¨ä¸åŒçš„èŠ¯ç‰‡ä¹‹é—´åˆ‡æ¢ã€‚åæ¥çš„å‡ ä»£äº§å“ä»ç›¸æœºé™„ä»¶åˆ°åŠ é€Ÿåº¦è®¡æ— æ‰€ä¸åŒ…ã€‚è¿™äº›åŠŸèƒ½ä¸­çš„æ¯ä¸€ä¸ªéƒ½å°†ä¾æ¬¡ç®€å•åœ°å†™å…¥ä¸“ç”¨çš„å†…å­˜åŒºåŸŸï¼Œæ¸¸æˆç”·å­©å¯ä»¥ä¾æ¬¡è¯»å–å¹¶ä½¿ç”¨æ¸¸æˆä»£ç ã€‚ç®€å•ï¼Œä½†æ˜¯æœ‰æ•ˆã€‚

æœ‰äº›è¿˜é…å¤‡äº†æŸç§ä¸»å­˜å‚¨å™¨ï¼Œç”¨äºå­˜å‚¨é«˜åˆ†å’Œä¿å­˜æ¸¸æˆç­‰å†…å®¹ï¼Œä»¥åŠä¸€ä¸ªå°ç”µæ± ï¼Œç”¨äºä¸ºæ‰€è¿°èŠ¯ç‰‡å……ç”µï¼Œä»¥é˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚

å®Œå…¨å±•å¼€åï¼Œç›’å¼ç£å¸¦çš„æœ‰æ•ˆå­˜å‚¨å®¹é‡ä» 32 KiB åˆ°å‡ å…†å­—èŠ‚ä¸ç­‰ã€‚

è¿™æ˜¯ä¸€ä¸ªå¼¹è¯ç­’ã€‚ä¸€ä¸ª*ROM*â€”â€”ROM æ˜¯*åªè¯»å­˜å‚¨å™¨*â€”â€”æ˜¯æ¨¡æ‹Ÿå™¨åœˆå­é‡Œçš„ä¸€ä¸ªé€šç”¨æœ¯è¯­ï¼Œç”¨æ¥æè¿°ä¸€ä¸ªç›’å¼ç£å¸¦ã€è½¯ç›˜ã€CD-r omâ€”â€”å®é™…ä¸Šæ˜¯ä»»ä½•ä¸œè¥¿â€”â€”çš„å…‹éš†ï¼Œå…¶å¸ƒå±€æ ¼å¼æ˜¯æ¨¡æ‹Ÿå™¨ç¼–å†™è€…å·²ç»åŒæ„çš„æ ¼å¼ã€‚å¯¹äºæ›´ç®€å•çš„äº‹æƒ…ï¼Œè¿™æ˜¯ 1:1 çš„æ˜ å°„ã€‚æŸå¤„èŠ¯ç‰‡ä¸­çš„ä¸€ä¸ªå­—èŠ‚ï¼›ä½ ç”µè„‘ä¸Šä¸€ä¸ªæ–‡ä»¶ä¸­çš„ä¸€ä¸ªå­—èŠ‚ã€‚Game Boy å¢¨ç›’å¤§å¤šæ˜¯è¿™æ ·å·¥ä½œçš„ï¼Œè¿™å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ä¸ªå¥½æ¶ˆæ¯ã€‚

é¦–å…ˆï¼Œå®é™…ä¸Šåœ¨ç›¸å½“é•¿çš„ä¸€æ®µæ—¶é—´å†…ï¼Œæˆ‘ä»¬ä¸ä¼šå¤ªæ‹…å¿ƒå¤æ‚çš„è®°å¿†åº“åˆ‡æ¢ï¼Œè€Œæ˜¯ä¸“æ³¨äºé‚£äº›*æ²¡æœ‰*æ‹¥æœ‰çš„æ¸¸æˆã€‚å®ƒä»¬ä»¥ä¸¤ç§æ–¹å¼ä¸­çš„ä¸€ç§å®¹æ˜“è¯†åˆ«:å¤§å°æ˜¯`32 KiB` *ç¡®åˆ‡åœ°è¯´æ˜¯*ï¼Œå¦ä¸€ç§æˆ‘ä»¬å°†åœ¨ç¨åè®¨è®ºå¦‚ä½•è¯»å‡ºç›’å¼ ROM å…ƒæ•°æ®æ—¶è®¨è®ºã€‚

 æˆ‘å»ºè®®ä½ å»çœ‹çœ‹[å®¶é…¿ä¸­å¿ƒ](https://gbhh.avivace.com/)ï¼ŒæŒ‘é€‰å‡ ä¸ªç®€å•çš„æ¸¸æˆï¼Œæ¯”å¦‚[è´ªåƒè›‡](https://gbhh.avivace.com/game/snake-gb)ã€‚ 

ç›’å¼åªè¯»å­˜å‚¨å™¨æ˜¯ç›’å¼å­˜å‚¨å™¨èŠ¯ç‰‡çš„å­—èŠ‚ç²¾ç¡®çš„åªè¯»å­˜å‚¨å™¨æ˜ åƒ

å› æ­¤ï¼Œç›’å¼åªè¯»å­˜å‚¨å™¨å°±æ˜¯ä»ç‰©ç†ç›’å¼å­˜å‚¨å™¨ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªèŠ¯ç‰‡ä¸­å–å‡ºçš„ä¸€ç³»åˆ—å­—èŠ‚ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„è¡¨ç¤ºï¼Œå› ä¸ºå®ƒå¾ˆå®¹æ˜“æ¨ç†ã€‚







æ¯ä¸ªå¢¨ç›’éƒ½æœ‰ä¸€ä¸ªè¢«ç§°ä¸º*å¢¨ç›’æ ‡é¢˜*çš„ä¿ç•™å†…å­˜åŒºåŸŸã€‚å¤§å¤šæ•°äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼éƒ½æœ‰ä¸€ä¸ªæ–‡ä»¶å¤´ï¼›æœ‰äº›è¿˜å¸¦æœ‰ä¸€ä¸ª*é¡µè„š*ï¼Œè¡¨ç¤ºæ–‡ä»¶æ ¼å¼å¯è¯»éƒ¨åˆ†çš„ç»“æŸã€‚éå¸¸å¤æ‚çš„ç”šè‡³å¯èƒ½æœ‰æ ¼å¼ä¸­çš„æ ¼å¼ã€‚

æ‚¨å¯ä»¥åœ¨ Linux ä¸Šä½¿ç”¨`xxd` hexdump å·¥å…·è‡ªå·±æµ‹è¯•è¿™ä¸€ç‚¹(åœ¨æœ¬ç³»åˆ—çš„åé¢ï¼Œæˆ‘ä»¬å°†ä¸ºæˆ‘ä»¬çš„äº¤äº’å¼è°ƒè¯•å™¨ç¼–å†™è‡ªå·±çš„å·¥å…·ã€‚)

 å¦‚æœä½ æ²¡æœ‰`xxd`å·¥å…·ï¼Œæˆ‘å»ºè®®ä½ ä¸‹è½½ä¸€ä¸ªå…è´¹çš„åå…­è¿›åˆ¶ç¼–è¾‘å™¨ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œä¸‹è½½è¯¥å·¥å…·ç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

å¦‚æœæ‚¨ä»¥å­—èŠ‚è¯»å–æ¨¡å¼æ‰“å¼€æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨`hex()`ï¼Œæ‚¨ä¹Ÿå¯ä»¥ç”¨ Python è½»æ¾åœ°åšåˆ°è¿™ä¸€ç‚¹ï¼›`format()`å¸¦`%x`çš„ç´å¼¦ï¼›æˆ–è€…ç”¨ f å¼¦ï¼Œåƒè¿™ä¸ª`{variable:x}`ã€‚

å¦‚æœä½ ä½¿ç”¨ Emacsï¼Œä½ åªéœ€è¾“å…¥`M-x hexl-find-file`ã€‚ 

ä»¥ä¸‹æ˜¯ ZIP æ–‡ä»¶çš„å‰å…«ä¸ªå…«ä½å­—èŠ‚:

```
$ xxd -l 8 test.zip
00000000: 504b 0304 1400 0000           PK......
^^^^^^^^
Offset    ^^^^^^^^^^^^^^^^^^^
          Hexadecimal representation    ^^^^^^^^
                                        Textual/Byte representation
```

å‰ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºâ€œPKâ€ï¼Œä»¥ PKZip å’Œ Zip æ ¼å¼çš„åˆ›å§‹äººè²åˆ©æ™®Â·å¡å…¹å‘½åã€‚å¤§å¤šæ•°æ–‡ä»¶éƒ½å¯ä»¥è¿™æ ·åšã€‚è¯•è¯•çœ‹ã€‚

ç„¶è€Œï¼Œå¦‚æœä½ ç”¨ä¸€ä¸ªç›’å¼ç£å¸¦è¯•ä¸€ä¸‹ï¼Œä½ ä¼šå¤§åƒä¸€æƒŠ:ç›’å¼ç£å¸¦ ROM çš„å¼€å¤´å®é™…ä¸Šå¹¶ä¸æ˜¯å¤´æ–‡ä»¶ã€‚

è¦åœ¨ ROM ä¸­æ‰¾åˆ°æ ‡é¢˜çš„ä½ç½®ï¼Œæ‰“å¼€ *Pandocs* å¹¶é€‰æ‹©[ç›’å¼æ ‡é¢˜](https://gbdev.io/pandocs/The_Cartridge_Header.html)ã€‚å¦‚æ–‡æ¡£æ‰€è¿°ï¼Œå‰²å°ä½äºåç§»é‡`0x100`ã€‚

å¡ç‰‡ç›’å¤´è¿˜åŒ…å«æ–‡å­—*ä»£ç *ï¼Œè€Œä¸ä»…ä»…æ˜¯*æ•°æ®*â€”â€”ç¨åä¼šè¯¦ç»†ä»‹ç»ã€‚

æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬åœ¨å®¶é…¿ä¸­å¿ƒçš„[ä¸Šè¯•è¯•å§:](https://gbhh.avivace.com/game/snake-gb)

```
$ xxd -s $((0x100)) -l $((0x0150 - 0x100)) snake.gb
00000100: 00c3 5001 ceed 6666 cc0d 000b 0373 0083  ..P...ff.....s..
00000110: 000c 000d 0008 111f 8889 000e dccc 6ee6  ..............n.
00000120: dddd d999 bbbb 6763 6e0e eccc dddc 999f  ......gcn.......
00000130: bbb9 333e 5976 6172 2773 2047 4220 536e  ..3>Yvar's GB Sn
00000140: 616b 6580 0000 0000 0000 0100 2d42 dec7  ake.........-B..
```

è¿™é‡Œæˆ‘ä½¿ç”¨ bashism å°†`0x100`è½¬æ¢æˆåè¿›åˆ¶`256`ã€‚

`-s`å¼€å…³æŒ‡ç¤ºèµ·å§‹ä½ç½®ï¼›`-l`è¡¨ç¤ºè¦è¯»å–å¤šå°‘å­—èŠ‚  ã€‚å­—èŠ‚æ•°åº”è¯¥ç­‰äºå¤´çš„å¤§å°ï¼›æ‰€ä»¥ä»`0x0150`å‡å»`0x100`çš„å¼€å§‹ã€‚

ä¸€äº›å·¥å…·å’Œæ–‡çŒ®ä½¿ç”¨*å…«ä½å­—èŠ‚*è€Œä¸æ˜¯*å­—èŠ‚*ï¼Œå› ä¸ºä¸€ä¸ª*å…«ä½å­—èŠ‚* ( *å…«ä½å­—èŠ‚*ï¼Œæ‹‰ä¸è¯­æ„ä¸ºå…«)æ˜¯ 8 ä½ï¼Œç›¸å½“äºä»Šå¤©çš„ä¸€ä¸ªå­—èŠ‚*â€”â€”ä½†æ˜¯åœ¨è¿‡å»ï¼Œä¸€ä¸ªå­—èŠ‚çš„ä½æ•°æ˜¯å¯å˜çš„ã€‚*

 *å¦‚æœä½ ä»”ç»†çœ‹ï¼Œä½ å¯ä»¥è¾¨è®¤å‡ºä¸€äº› ASCII å­—ç¬¦â€”â€”è¿™å°±æ˜¯æ ‡é¢˜ã€‚ä»åç§»é‡`0x130`å¼€å§‹ä»å·¦å‘å³è®¡æ•°ï¼Œå¾—åˆ°`0x134`ï¼Œè¿™æ˜¯ pandocs æ–‡æ¡£ä¸­çš„å¢¨ç›’åç§°ã€‚

 é—®é—®ä½ è‡ªå·±ï¼Œå½“æ ‡é¢˜åœ¨`0x014F`å¤„â€œç»“æŸâ€æ—¶ï¼Œæˆ‘ä¸ºä»€ä¹ˆè¦ä½¿ç”¨`0x0150`ã€‚ 

è¿™å°±æ˜¯å¦‚ä½•ä» hexdump ä¸­æ‰‹åŠ¨è¯»å–ç›’å¼ç£å¸¦å¤´çš„æ–¹æ³•ã€‚ä¿¡æ¯ä¸°å¯Œï¼Œä½†å®ƒæ²¡æœ‰æ¨è¿›æˆ‘ä»¬çš„æ¨¡æ‹Ÿå™¨é¡¹ç›®ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç®€å•çš„ç›’å¼å…ƒæ•°æ®è¯»å–å™¨ã€‚* 

 *

### ä½¿ç”¨`struct`æ¨¡å—è§£åŒ…äºŒè¿›åˆ¶æ•°æ®

å¤§å¤šæ•°è¯­è¨€éƒ½æœ‰æŸç§ç¬¦å·æ¥è¡¨ç¤º*ç±»å‹çš„*æ•°æ®é›†åˆã€‚åœ¨ C ä¸­æ˜¯`struct`ã€‚åœ¨ Pascal é‡Œæ˜¯`record`ã€‚è¿™æ˜¯ä¸€ç§æœ‰æ•ˆçš„*ç»„ç»‡*ä¿¡æ¯çš„æ–¹å¼ï¼Œå°¤å…¶æ˜¯å½“ä½ å¯ä»¥å‘½ä»¤ç¼–è¯‘å™¨(å¦‚æœæœ‰çš„è¯)ä»¥è¿™æ ·ä¸€ç§æ–¹å¼*æ‰“åŒ…*è¯¥ç»“æ„æ—¶ï¼Œä½ å¯ä»¥å®Œå…¨æ§åˆ¶è¯¥ç»“æ„çš„å¸ƒå±€ï¼Œä¸€ä½ä¸€ä½åœ°ï¼Œåœ¨å†…å­˜å’Œç£ç›˜ä¸Šã€‚å½“æ‚¨æƒ³è¦è¡¨ç¤ºå­—èŠ‚é›†åˆæ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„å±æ€§ï¼Œå°±åƒæˆ‘ä»¬éœ€è¦å¤„ç†ç›’å¼ç£å¸¦çš„å¤´å…ƒæ•°æ®ä¸€æ ·ã€‚

åœ¨ Python ä¸­ï¼Œä½ å¯ä»¥ç”¨æ— æ•°ç§æ–¹å¼æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ç„¶è€Œï¼Œé—®é¢˜æ˜¯ï¼Œåƒè¿™æ ·çš„äºŒè¿›åˆ¶ç»“æ„éœ€è¦æœ‰ç²¾ç¡®çš„çœ¼å…‰:ä½ ä¸ä»…éœ€è¦ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚åœ°è¯»å‡ºä¿¡æ¯ï¼Œè¿˜éœ€è¦è€ƒè™‘ä»¥ä¸‹äº‹é¡¹:

å­—èŠ‚é¡ºåºï¼Œå³è¯»å–å­—èŠ‚åºåˆ—çš„æ–¹å‘

å¤§ç«¯å’Œå°ç«¯ç³»ç»Ÿå¯¹å­—èŠ‚ç»“æ„çš„è§£é‡Šä¸åŒã€‚Z80 æ˜¯å¤§ç«¯ CPUï¼Œè€Œä½ çš„å¯èƒ½æ˜¯å°ç«¯ CPUã€‚

åœ¨ä½ çš„ Python è§£é‡Šå™¨ä¸­è¾“å…¥`sys.byteorder`æ¥ç¡®å®šã€‚

æœ‰ç¬¦å·ä¸æ— ç¬¦å·æ•´æ•°

æ— ç¬¦å·æ•´æ•°ä»…æ˜¯æ­£æ•´æ•°ã€‚å¦ä¸€æ–¹é¢ï¼ŒSigned æ—¢æ˜¯å¦å®šçš„ï¼Œä¹Ÿæ˜¯è‚¯å®šçš„ã€‚æ‚¨é€‰æ‹©çš„è¡¨ç¤ºå°†å†³å®šå­—èŠ‚å­—ç¬¦ä¸²ä¸­ä¿å­˜çš„å€¼ã€‚

ç”¨çº¿ä¸²

æ˜¯ C é£æ ¼çš„å­—ç¬¦ä¸²è¿˜æ˜¯ Pascal é£æ ¼çš„ï¼Ÿå‰è€…ç”¨ä¸€ä¸ª NUL å­—ç¬¦ç»“æŸä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä»¥è¡¨ç¤ºåˆ°è¾¾äº†ç»“å°¾ã€‚ä½†æ˜¯ Pascal å­—ç¬¦ä¸²ä¼šåœ¨å®ƒä»¬çš„å‰é¢åŠ ä¸Šå­—ç¬¦ä¸²çš„å­—èŠ‚å¤§å°ã€‚

å¤§å°

ä½ è¯»çš„æ˜¯ 8 ä½æ•°è¿˜æ˜¯ 16 ä½æ•°ï¼Ÿä¹Ÿè®¸æ˜¯æ›´å¤§çš„ï¼Ÿ

è¿™æ ·çš„ä¾‹å­ä¸èƒœæšä¸¾ã€‚æ¢å¥è¯è¯´ï¼Œç»„æˆæˆ‘ä»¬æ•°æ®çš„æ¯”ç‰¹å’Œå­—èŠ‚æ˜¯ä¸€ä¸ª*è¡¨ç¤º*çš„é—®é¢˜ã€‚å¦‚æœå¼„é”™äº†ï¼Œä½ ä¼šè¯»åˆ°åƒåœ¾ï¼Œæˆ–è€…æ›´ç³Ÿçš„æ˜¯ï¼Œå®ƒåªé€‚ç”¨äºæŸäº›å€¼ï¼Œè€Œä¸é€‚ç”¨äºå…¶ä»–å€¼ï¼

å¹¸è¿çš„æ˜¯ï¼ŒPython é™„å¸¦çš„`struct`æ¨¡å—èƒ½å¤Ÿå¤„ç†æ‰€æœ‰è¿™äº›é—®é¢˜ã€‚ä½¿ç”¨ä¸€ç§å°å‹è¯­è¨€ï¼Œå°±åƒæ‚¨ç”¨äºæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„è¯­è¨€ä¸€æ ·ï¼Œæ‚¨å¯ä»¥å‘Šè¯‰ Python å¦‚ä½•è§£é‡ŠäºŒè¿›åˆ¶æ•°æ®æµã€‚



#### å¤§å°ç«¯åº

å…ˆç®€å•è¯´ä¸€ä¸‹*å­—èŠ‚åº*ä»¥åŠå®ƒæ˜¯ä»€ä¹ˆã€‚å®ƒåœ¨æˆ‘ä»¬å¦‚ä½•é˜…è¯»å’Œè¡¨è¾¾ä¿¡æ¯æ–¹é¢èµ·ç€é‡è¦çš„ä½œç”¨ã€‚è¿™æ˜¯ä½ è¯»å–æ•°æ®å­—èŠ‚çš„*åºåˆ—*çš„é¡ºåºã€‚

 ä¸€ä¸ªä»ã€Šæ ¼åˆ—ä½›æ¸¸è®°ã€‹è¿™æœ¬ä¹¦é‡Œå€Ÿæ¥çš„åè¯ï¼Œåˆ°å¤„éƒ½æ˜¯ã€‚ 

å› æ­¤ï¼Œè€ƒè™‘ä»¥ä¸‹ Python ä¸­çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²:

```
>>> data =  bytes.fromhex('AB CD') >>> data b'\xab\xcd'
```

å½“é‚£ä¸ªå­—èŠ‚ä¸²ç”¨*è¡¨ç¤º*ä¸ºå°ç«¯æˆ–å¤§ç«¯æ—¶ï¼Œåè¿›åˆ¶å€¼ä¼šæ”¹å˜ã€‚å›æƒ³ä¸€ä¸‹ï¼Œæ­¤æ—¶å®ƒåªæ˜¯ä¸€ä¸ªå­—èŠ‚ä¸²ï¼›å®ƒè¿˜æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚è¿™æ„å‘³ç€å¦‚æœä½ ä¸çŸ¥é“å†™å®ƒçš„äººé€‰æ‹©çš„æ˜¯å¤§ç«¯è¿˜æ˜¯å°ç«¯ï¼Œåå…­è¿›åˆ¶å­—ç¬¦ä¸²`AB CD`çš„*æ•°å€¼*å°±æ˜¯ä¸æ˜ç¡®çš„ï¼

è€ƒè™‘ä¹‹å‰çš„å˜é‡`data`:

```
>>> little =  int.from_bytes(data,  'little') >>> big =  int.from_bytes(data,  'big') >>>  (little, big) (52651,  43981) >>>  (hex(little),  hex(big)) ('0xcdab',  '0xabcd')
```

è¿™æ˜¯å› ä¸ºä¸¤ç§å­—èŠ‚åºæ ¼å¼çš„æ•°æ®æ–¹å‘ä¸åŒã€‚å°ç«¯è§£é‡Šä¸º`CD AB`ï¼Œå¤§ç«¯è§£é‡Šä¸º`AB CD`ã€‚

ç°åœ¨ä½ å¯èƒ½æƒ³çŸ¥é“ä¸ºä»€ä¹ˆæ˜¯`CD AB`è€Œä¸æ˜¯`DC BA`â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ºä»€ä¹ˆè¾¹ç•Œæ˜¯ä¸€ä¸ªå­—èŠ‚è€Œä¸æ˜¯åŠä¸ªå­—èŠ‚ï¼Ÿ

æ€»ä¹‹ï¼Œå¤§å¤šæ•° CPU(è‡³å°‘)æ˜¯ 8 ä½å¯å¯»å€çš„ï¼Œè¿™æ„å‘³ç€åœ°å€æ€»çº¿å°†è¯»å–å’Œå†™å…¥è‡³å°‘ 8 ä½(æˆ– 1 ä¸ªå­—èŠ‚)çš„æ•°æ®ã€‚Game Boy æœ‰ä¸€ä¸ª 8 ä½ CPU *ï¼Œä½†*æœ‰ 16 ä½å¯å¯»å€æ€»çº¿ï¼Œå› æ­¤å®ƒè¿è¡Œçš„æœ€å°å•ä½æ˜¯ 1 å­—èŠ‚ã€‚

å¥‡æ€ªçš„ CPU å¹³å°å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œ50 å¹´å‰å¾ˆå¤šéƒ½æ˜¯å¦‚æ­¤ï¼Œä½†å°±æˆ‘ä»¬è€Œè¨€ï¼Œä»Šå¤©çš„ CPU è¿è¡Œåœ¨ 8 ä½çš„å€æ•°ä¸Šã€‚

ä¸ºäº†è¿›è¡Œæ¼”ç¤ºï¼Œæ‚¨å¯ä»¥å°†ä»»ä½•åè¿›åˆ¶æ•°è½¬æ¢ä¸ºä»¥å¤§ç«¯æˆ–å°ç«¯é¡ºåºå¡«å……åˆ°ç»™å®šé•¿åº¦çš„å­—èŠ‚å­—ç¬¦ä¸²ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä½¿ç”¨åå…­è¿›åˆ¶ç¬¦å·æ¥åŒ¹é…å‰é¢çš„ç¤ºä¾‹å­—èŠ‚å­—ç¬¦ä¸²ä¸­çš„ä¸€ä¸ªå­—èŠ‚(å…³é”®å­—`length`)ã€‚

```
>>>  int.to_bytes(0xCD, length=1, byteorder='little') b'\xcd'
```

```
>>>  int.to_bytes(0xCD, length=1, byteorder='big') b'\xcd'
```

å¦‚æ‚¨æ‰€è§ï¼Œæ²¡æœ‰å‘ç”Ÿå­—èŠ‚ç½®æ¢ã€‚åŸå› æ˜¯è¿™æ ·çš„:ç”±äºæˆ‘ä»¬æ“ä½œçš„æœ€å°å•ä½æ˜¯ 8 ä½ï¼Œæ‰€ä»¥æ— è®ºæ˜¯ä»å·¦åˆ°å³è¿˜æ˜¯ä»å³åˆ°å·¦é˜…è¯»éƒ½æ²¡æœ‰åŒºåˆ«ï¼›`0xCD`è¿™ä¸ªè¯å°±æ˜¯`0xCD`è€Œå·²ã€‚ç°åœ¨ï¼Œæ‹¥æœ‰*ä½çº§*(ç›¸å¯¹äº*å­—èŠ‚çº§*)å­—èŠ‚åºæ˜¯å®Œå…¨å¯èƒ½çš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ è¯»å–ä½çš„é¡ºåºæ˜¯å˜åŒ–çš„ã€‚ä½†è¿™é‡Œçš„æƒ…å†µå¹¶éå¦‚æ­¤ã€‚

ç°åœ¨å†ä¸€æ¬¡ï¼Œä½†æ˜¯å¤§å°ä¸º 2(å³ 16 ä½):

```
>>>  int.to_bytes(0xCD, length=2, byteorder='big') b'\x00\xcd'
```

```
>>>  int.to_bytes(0xCD, length=2, byteorder='little') b'\xcd\x00'
```

ç°åœ¨ï¼Œå®ƒç¡®å®ç”¨ Python è½¬ç½®äº†(æŒ‰ç…§ä¹‹å‰çš„è§„åˆ™)é¢å¤–çš„å­—èŠ‚ï¼Œç”¨å°ç«¯å­—èŠ‚åºä¸­çš„`0x00`å¡«å……ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿæ­£ç¡®è¯»å– 2 ä¸ªå­—èŠ‚çš„å°ç«¯æ’åºæ•°æ®ã€‚







### åœ¨å¤§ç«¯å’Œå°ç«¯ä¹‹é—´è½¬æ¢

æ­£å¦‚ä¸Šé¢çš„ä¾‹å­æ‰€å±•ç¤ºçš„ï¼Œæ‚¨å¯ä»¥è®© Python æ¥å®Œæˆåœ¨ big å’Œ little endian ä¹‹é—´è½¬æ¢çš„è‰°è‹¦å·¥ä½œã€‚ä½†æ˜¯æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ç§»ä½æ¥æ‰‹åŠ¨äº¤æ¢å®ƒä»¬:

é€šè¿‡ç§»ä½åœ¨å¤§ç«¯å’Œå°ç«¯ä¹‹é—´è½¬æ¢ 16 ä½å€¼

æˆ‘ç°åœ¨è¿˜ä¸ä¼šè¿‡å¤šåœ°è®¨è®ºè¿™ä¸ªæ–¹æ³•ï¼›è¯·æ”¾å¿ƒï¼Œç¨åå½“æˆ‘ä»¬å¼€å§‹æ‰§è¡Œ Z80 çš„æŒ‡ä»¤æ—¶ï¼Œèœå•ä¸Šä¼šæœ‰ä¸€ç‚¹æ— èŠã€‚

```
>>> value =  0xABCD >>>  hex(((value &  0xFF00)  >>  8)  |  (value &  0xFF)  <<  8) '0xcdab'
```

å½“ç„¶ï¼Œè¿™ç§æ–¹æ³•ä¹Ÿé€‚ç”¨äºå¤§äº 16 ä½çš„å€¼ï¼Œåªéœ€ç¨åŠ ä¿®æ”¹ã€‚

ç”¨`int`åœ¨å¤§ç«¯å’Œå°ç«¯ä¹‹é—´è½¬æ¢ä»»æ„å€¼

è¯¥æ–¹æ³•å°†ä»»æ„æ•´æ•°è½¬æ¢ä¸ºç»™å®šå­—èŠ‚é¡ºåºçš„å­—èŠ‚å­—ç¬¦ä¸²â€“`little`æˆ–`big`ã€‚

```
>>>  0xC0FFEE.to_bytes(length=3, byteorder='big') b'\xc0\xff\xee' >>>  >>>  int.to_bytes(0xC0FFEE, length=3, byteorder='little') b'\xee\xff\xc0'
```

 å› ä¸ºæ•´æ•°æ˜¯ Python ä¸­çš„å¯¹è±¡ï¼Œæ‰€ä»¥å®ƒä»¬å¸¦æœ‰å„ç§å„æ ·çš„æ–¹æ³•ï¼Œæ‚¨å¯ä»¥ç›´æ¥å¯¹å®ƒä»¬è¿›è¡Œè°ƒç”¨ã€‚æˆ‘æ•¦ä¿ƒä½ æŠµåˆ¶ç”¨æ–‡å­—å€¼æ¥åšè¿™ä»¶äº‹çš„è¯±æƒ‘ï¼Œè€Œä½¿ç”¨`int`ã€‚å®ƒæ›´å®¹æ˜“é˜…è¯»ã€‚ 

ä½¿ç”¨`array`æ¨¡å—

`array`æ¨¡å—æ˜¯ Python é™„å¸¦çš„ä¸€ä¸ªåŸºæœ¬æ•°ç»„å®ç°ã€‚ä½ ç»™å®ƒä¸€ä¸ªå¤§å°åˆå§‹åŒ–å™¨(ä¸‹ä¸€èŠ‚å°†è¯¦ç»†ä»‹ç»å®ƒä»¬çš„å«ä¹‰)â€”â€”æœ‰ç‚¹åƒ numpy ä¸­çš„`dtype`â€”â€”Python å¤„ç†å‰©ä¸‹çš„äº‹æƒ…ã€‚å¦‚æœä½ æœ‰ä¸€ä¸ªæ•°ç»„å……æ»¡äº†ä½ æƒ³è¦äº¤æ¢çš„å€¼ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆæœ‰ç”¨ã€‚

```
>>> a = array.array('H',  b'\xAB\xCD\x00\x01') >>> a array('H',  [52651,  256]) >>> a.byteswap() >>> a array('H',  [43981,  1])
```



#### å­—èŠ‚å­—ç¬¦ä¸²å’Œç±»å‹è¡¨ç¤º

é¦–å…ˆï¼Œæ‚¨éœ€è¦æ”¶é›† Pandocs ä¸­çš„[å¢¨ç›’æ ‡é¢˜](https://gbdev.io/pandocs/The_Cartridge_Header.html)éƒ¨åˆ†ä¸­è¡¨ç¤ºçš„æ‰€æœ‰å­—æ®µï¼Œå¹¶å°†å®ƒä»¬åˆ†åˆ«æ˜ å°„åˆ°æ‚¨åœ¨[ç»“æ„æ ¼å¼å­—ç¬¦](https://docs.python.org/3/library/struct.html?highlight=struct#format-characters)ä¸­çœ‹åˆ°çš„å­—æ®µã€‚

ä¸€æ—¦ç†è§£äº†åŸºç¡€çŸ¥è¯†ï¼Œå°†å®ƒä»¬æ˜ å°„åˆ°å­—æ®µå¹¶ä¸å›°éš¾ã€‚ä¸è¿‡ï¼Œè¦è®°ä½çš„ä¸»è¦ä¸€ç‚¹æ˜¯ï¼Œæˆ‘ä»¬**åªå¯¹**å­—èŠ‚è¿›è¡Œæ“ä½œï¼Œå°±åƒè¿™æ ·:

```
>>>  b'Inspired Python' b'Inspired Python'
```

å­—èŠ‚å­—ç¬¦ä¸²åœ¨è¿™é‡Œå¾ˆé‡è¦ï¼Œå› ä¸ºä¸ä¼šå‘ç”Ÿä¸è®¡ç®—æœºçš„*åŒºåŸŸè®¾ç½®*çš„ç›¸äº’è½¬æ¢ï¼›å®ƒåªæ˜¯åŸå§‹å½¢å¼ï¼Œæ²¡æœ‰ç»è¿‡ä»»ä½•åˆ°`UTF-8`æˆ–å…¶ä»–å­—ç¬¦ç¼–ç çš„è½¬æ¢ã€‚

è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªå­—èŠ‚ä¸²ï¼Œé‡Œé¢æœ‰ä¸€å †è½¬ä¹‰ç¼–ç çš„ä¸œè¥¿:

```
>>>  b'\xf0\x9f\x90\x8d' b'\xf0\x9f\x90\x8d'
```

```
>>>  b'\xf0\x9f\x90\x8d'.decode('utf-8') 'ğŸ'
```

å½“æˆ‘*å°†å®ƒä»å­—èŠ‚æ ¼å¼è§£ç æˆ`UTF-8`æ—¶ï¼Œæˆ‘å¾—åˆ°äº†â€¦â€¦ä¸€æ¡è›‡ã€‚æ‰€ä»¥å­—èŠ‚ä¸²åªæ˜¯ä¸€æ®µåŸå§‹çš„å­—èŠ‚ã€‚å®ƒå¯ä»¥æœ‰ä»»ä½•æ„ä¹‰ï¼Œç›´åˆ°æˆ‘ä»¬èµ‹äºˆå®ƒç›®çš„:å°†å…¶è½¬æ¢ä¸º UTF-8 äº§ç”Ÿä¸€æ¡è›‡ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä½¿ç”¨`struct.unpack_from`ï¼Œæˆ‘å¯ä»¥å‘Šè¯‰ Python å®ƒå¿…é¡»å°†å…¶è¡¨ç¤ºä¸ºä¸€ä¸ª*æ— ç¬¦å·æ•´æ•°*:*

```
>>> struct.unpack_from('I',  b'\xf0\x9f\x90\x8d') (2375065584,)
```

è¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦å¯¹ç›’å¼ç£å¸¦å¤´åšä»€ä¹ˆçš„å…³é”®ã€‚æˆ‘ä»¬éœ€è¦æƒ³å‡ºä¸€ç³»åˆ—æ ¼å¼å­—ç¬¦ä¸²ç»™`unpack_from`,è¿™æ ·å®ƒæ‰èƒ½å‘æŒ¥å®ƒçš„é­”åŠ›ã€‚

å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬åªéœ€è¦å‡ ä¸ªä¸åŒçš„:

| æ ¼å¼å­—ç¬¦ä¸² | â€œCâ€ç­‰æ•ˆå‹ | ç›®çš„ |
| T2`x` | å¡«å……å­—èŠ‚ | è·³è¿‡ä¸€ä¸ªå­—èŠ‚æˆ–å¡«å……å¦ä¸€ä¸ªæ ¼å¼å­—ç¬¦ä¸²ã€‚å¯¹æˆ‘ä»¬ä¸å…³å¿ƒçš„ä¸œè¥¿æœ‰ç”¨ã€‚ |
| T2`=` | ä½¿ç”¨ç³»ç»Ÿçš„åŸç”Ÿå­—èŠ‚åºæ ¼å¼ | å¤§æ¦‚å°±æ˜¯ä½ æƒ³è¦çš„ã€‚Python å°†å†³å®šåœ¨è¯»å–æ•°æ®æ—¶åº”è¯¥ä½¿ç”¨å°ç«¯è¿˜æ˜¯å¤§ç«¯ |
| `>`ï¼Œ`<` | å¤§&å°ç«¯æŒ‡æ ‡ï¼Œåˆ†åˆ«ä¸º | éå¸¸é‡è¦ã€‚Z80 ä»¥å¤§ç«¯é¡ºåºå­˜å‚¨ä¸œè¥¿ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬çš„ç³»ç»Ÿæ˜¯å°ç«¯é¡ºåºï¼Œæˆ‘ä»¬åº”è¯¥å‘Šè¯‰å®ƒç”¨å°ç«¯é¡ºåºæ¥è¡¨ç¤ºã€‚ *æ³¨æ„*:å¿…é¡»æ˜¯æ ¼å¼å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ã€‚ |
| T2`s` | å­—ç¬¦æ•°ç»„ | é€‚ç”¨äºä»»æ„é•¿åº¦çš„æ–‡æœ¬ã€‚ å¸¦å‰ç¼€è¡¨ç¤ºé•¿åº¦ï¼Œåƒ`10s`ã€‚ |
| T2`H` | æ— ç¬¦å·çŸ­æ•´å‹ | 2 å­—èŠ‚æ— ç¬¦å·æ•´æ•° |
| T2`B` | æ— ç¬¦å·å­—ç¬¦ | ç”¨ä½œ 1 å­—èŠ‚æ— ç¬¦å·æ•´æ•° |

å› æ­¤ï¼Œè¦ä½¿ç”¨å®ƒï¼Œæ‚¨å¯ä»¥å°†æ ¼å¼å­—ç¬¦ä¸²ç»„åˆæˆä¸€ç³»åˆ—è§£åŒ…æŒ‡ä»¤ã€‚è€ƒè™‘è¿™ä¸ªç®€å•çš„ä¾‹å­ï¼Œå®ƒæå–äº†å‡ ä¸ªæ•°å­—â€”â€”ä»¥*å¤§ç«¯å­—èŠ‚åº*â€”â€”å’Œä¸€ä¸ªå­—ç¬¦ä¸²:

```
>>> struct.unpack_from('>BB5sH',  b'\x01\x02HELLO\x03\x04') (1,  2,  b'HELLO',  772)
```

å¯†åˆ‡å…³æ³¨`>`ã€‚å°è¯•ç”¨`<`è¿è¡Œä»£ç ï¼Œç„¶åç”¨`=`å†æ¬¡è¿è¡Œã€‚

è¦è®°ä½çš„å…³é”®æ˜¯:

æ‚¨æƒ³è¦å°†*è½¬æ¢ä¸º*æ‚¨çš„å¹³å°çš„æœ¬æœº endian æ ¼å¼

æˆ‘çš„æ„æ€æ˜¯ï¼Œä½ æ²¡æœ‰æ—¶é—´å»åšï¼Œä½†æ˜¯ä½ å¿…é¡»åœ¨ç²¾ç¥ä¸Šå’Œç¨‹åºä¸Šä¸€ç›´äº¤æ¢ä¸œè¥¿ã€‚ä¸å¥½ç©ã€‚

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼ŒZ80 æ˜¯å¤§ç«¯å­—èŠ‚åºï¼Œæ‰€ä»¥å¦‚æœä½ çš„å¹³å°ä¹Ÿæ˜¯å°ç«¯å­—èŠ‚åºï¼Œä½ åº”è¯¥æŠŠå®ƒè½¬æ¢æˆå°ç«¯å­—èŠ‚åº**ã€‚å¦‚æœæ˜¯ big endianï¼Œå°±ä¸éœ€è¦è½¬æ¢æˆ–è€…æ”¹å˜ä»€ä¹ˆã€‚**

äº†è§£å­—èŠ‚é¡ºåºè‡³å…³é‡è¦

å¦‚æœä½ ä¸çŸ¥é“äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼çš„å­—èŠ‚é¡ºåºï¼Œä½ å°±æœ‰ç‚¹éº»çƒ¦äº†ã€‚æ‚¨å¯ä»¥å°è¯•é€šè¿‡å¯»æ‰¾æ ¼å¼ç±»å‹ç¼–ç çš„è¿¹è±¡æ¥é€†å‘å·¥ç¨‹å¯èƒ½çš„å­—èŠ‚é¡ºåºï¼Œå¦‚äºŒè¿›åˆ¶è¡¥ç ã€æµ®ç‚¹ã€ASCII å­—ç¬¦ä¸²ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªæ¼«é•¿çš„è¿‡ç¨‹ã€‚

è®°ä½è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬ç»§ç»­ä½¿ç”¨ç›’å¼ç£å¸¦é˜…è¯»å™¨ã€‚







```
FIELDS =  [   (None,  "="), (None,  'xxxx'), (None,  '48x'), ("title",  '15s'), ("cgb",  'B'), ("new_licensee_code",  'H'), ("sgb",  'B'), ("cartridge_type",  'B'), ("rom_size",  'B'), ("ram_size",  'B'), ("destination_code",  'B'), ("old_licensee_code",  'B'), ("mask_rom_version",  'B'), ("header_checksum",  'B'), ("global_checksum",  'H'), ]
```

`struct.unpack_from`çš„æ ¼å¼å­—ç¬¦ä¸²å¿…é¡»æ˜¯è¿ç»­çš„ï¼Œå› ä¸ºå®ƒä¸æ”¯æŒæ¢è¡Œç¬¦å’Œæ³¨é‡Šã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ä½¿åŸæœ¬æ··ä¹±çš„å­—æ¯æ±¤å˜å¾—æ›´åŠ æ¸…æ™°ï¼Œæˆ‘å»ºç«‹äº†ä¸€ä¸ªå…ƒç»„åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç»„åŒ…å«æœªæ¥çš„*å±æ€§*ï¼Œæˆ‘å¸Œæœ›ä»¥åå¼•ç”¨è¿™ä¸ªå€¼ã€‚å¦‚æœå®ƒæ˜¯`None`,å®ƒè¡¨æ˜æˆ‘æ ¹æœ¬ä¸æƒ³å­˜å‚¨è¿™ä¸ªå€¼ã€‚

è‡³æ­¤ï¼Œç›’å¼å…ƒæ•°æ®å·®ä¸å¤šå®Œæˆäº†â€”â€”ä¸ç®¡æ€æ ·ï¼Œè¿™æ˜¯æœ€éš¾çš„éƒ¨åˆ†ã€‚ç°åœ¨ï¼Œåœ¨æˆ‘ä»¬æ·±å…¥ç ”ç©¶è¿›è¡Œå®é™…è¯»å–çš„ä»£ç ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨å‡è®¾ç¼–å†™ä¸€ä¸ªå¿«é€Ÿæµ‹è¯•ã€‚

```
import sys import hypothesis.strategies as st from hypothesis import given   HEADER_START =  0x100 HEADER_END =  0x14F  HEADER_SIZE =  (HEADER_END - HEADER_START)  +  1   @given(data=st.binary(min_size=HEADER_SIZE + HEADER_START,   max_size=HEADER_SIZE + HEADER_START)) def  test_read_cartridge_metadata_smoketest(data):   def  read(offset, count=1): return data[offset: offset + count +  1]   metadata = read_cartridge_metadata(data) assert metadata.title == read(0x134,  14) checksum = read(0x14E,  2)   assert metadata.global_checksum ==  int.from_bytes(checksum, sys.byteorder)
```

è¿™é‡Œæœ‰ä¸€ç‚¹è¦è§£å¼€ï¼Œè®©æˆ‘ä»¬ä»é¡¶éƒ¨å¼€å§‹ã€‚æˆ‘å®šä¹‰äº†ä¸€äº›åœ¨æµ‹è¯•ä¸­ä½¿ç”¨çš„å¸¸é‡ã€‚ç°åœ¨ï¼Œæ‚¨å·²ç»çŸ¥é“äº†å¡ç‰‡å¤´çš„å¼€å§‹å’Œç»“æŸå€¼:å®ƒä»¬å’Œå…¶ä»–å¡ç‰‡å¤´å…ƒæ•°æ®`FIELDS`ä¸€èµ·å–è‡ª pandocsã€‚

æµ‹è¯•æœ¬èº«ä½¿ç”¨å‡è®¾æ¥ç”Ÿæˆä¸€ä¸ª`min_size`å’Œ`max_size`çš„*éšæœº*äºŒè¿›åˆ¶åƒåœ¾åˆ†ç±»ï¼Œç­‰äºæŠ¥å¤´çš„å¤§å°*åŠ ä¸Šå…¶åç§»é‡*ã€‚è™½ç„¶æˆ‘å¯ä»¥å¾ˆå®¹æ˜“åœ°ç”¨`-0x100`æ¥æŠµæ¶ˆä¸€åˆ‡ï¼Œä½†æ˜¯æˆ‘å–œæ¬¢è¿™ä¸ªæƒ³æ³•ï¼Œæˆ‘ä¹Ÿåœ¨æµ‹è¯•æˆ‘ä»¬å¯ä»¥ä»æ­£ç¡®çš„åç§»é‡è¯»å–ã€‚

æµ‹è¯•æœ¬èº«çš„ç‰¹ç‚¹æ˜¯`read()`ï¼Œä¸€ä¸ªåŠ©æ‰‹å‡½æ•°ä»`offset`ä¸­è¯»å–`count`ä¸ªå­—èŠ‚ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ `+1`ï¼Œå› ä¸ºå¦‚æœ`offset = count = 1`é‚£ä¹ˆ`data[1:1] == ''`ã€‚

`read_cartridge_metadata`è°ƒç”¨å®šåˆ¶ä»£ç æ¥è¯»å–å…ƒæ•°æ®â€”â€”ä¸‹é¢å°†è¯¦ç»†ä»‹ç»â€”â€”å¹¶æ£€æŸ¥å®ƒæ˜¯å¦è¯»å–äº†ä¸€äº›å­—æ®µã€‚æˆ‘é€‰æ‹©äº†*æ ‡é¢˜*ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œé€‰æ‹©äº†*å…¨å±€æ ¡éªŒå’Œ*ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªä¸¤å­—èŠ‚çš„å­—æ®µï¼Œå› æ­¤æ­£ç¡®çš„å­—èŠ‚é¡ºåºå¾ˆé‡è¦ã€‚

æœ€ç»ˆæ£€æŸ¥ç¡®ä¿æˆ‘ä»¬è¯»å…¥æ ¡éªŒå’Œï¼Œå°±å¥½åƒå®ƒæ˜¯ big endian ä¸€æ ·ã€‚

ç°åœ¨å¯¹äºç›’å¼ç£å¸¦é˜…è¯»å™¨æœ¬èº«:

```
CARTRIDGE_HEADER =  "".join(format_type for _, format_type in FIELDS)   CartridgeMetadata = namedtuple(   "CartridgeMetadata", [field_name for field_name, _ in FIELDS if field_name is  not  None], )   def  read_cartridge_metadata(buffer, offset:  int  =  0x100):   """ Unpacks the cartridge metadata from `buffer` at `offset` and returns a `CartridgeMetadata` object. """ data = struct.unpack_from(CARTRIDGE_HEADER,  buffer, offset=offset) return CartridgeMetadata._make(data)
```

æ²¡é”™ã€‚å°±æ˜¯è¿™æ ·ã€‚`CARTRIDGE_HEADER`ä»`FIELDS`ä¸­å–å‡ºæ¯ä¸ªå…ƒç»„ä¸­çš„é”®ï¼Œè€Œ`CartridgeMetadata`æ˜¯æˆ‘ä»¬å°†æ¯ä¸ª`field_name`æ˜ å°„åˆ°çš„`namedtuple`ï¼Œä¹Ÿå°±æ˜¯*è€Œä¸æ˜¯*T5ã€‚

`struct.unpack_from`å‡½æ•°å®Œæˆäº†å¤§éƒ¨åˆ†ç¹é‡çš„å·¥ä½œã€‚å®ƒéœ€è¦ä¸€ä¸ªå¯é€‰çš„`offset`ï¼Œæˆ‘ä»¬é»˜è®¤ä¸º`0x100`çš„é€šå¸¸ä½ç½®ã€‚è§£åŒ…åçš„å€¼å…ƒç»„è¢«ç›´æ¥è¾“å…¥åˆ°`CartridgeMetadata._make`ä¸­ï¼Œåè€…å°†æ•´ä¸ªäº‹æƒ…è½¬æ¢æˆä¸€ç§æ›´æ˜“äºè®¿é—®çš„æ ¼å¼:

```
>>> p = Path('snake.gb') >>> read_cartridge_metadata(p.read_bytes()) CartridgeMetadata(   title=b"Yvar's GB Snake", cgb=128, new_licensee_code=0, sgb=0, cartridge_type=0, rom_size=0, ram_size=0, destination_code=1, old_licensee_code=0, mask_rom_version=45, header_checksum=66, global_checksum=51166, )
```

è¿™å°±æ˜¯ç›’å¼ç£å¸¦å…ƒæ•°æ®è¯»å–å™¨ã€‚

å­—èŠ‚åºå¾ˆé‡è¦

ä½†å‰ææ˜¯ä½ ä¸€æ¬¡ä»£è¡¨çš„*å¤šäºä¸€ä¸ªå­—èŠ‚çš„*ã€‚Z80 CPU æ˜¯ Big Endianï¼Œæ‰€ä»¥åœ¨è¯»å–å€¼æ—¶è¦è®°ä½è¿™ä¸€ç‚¹ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯å°ç«¯ CPU ( `sys.byteorder`å‘Šè¯‰ä½ æ˜¯å“ªä¸ª),é‚£ä¹ˆè¿™å°±æ˜¯ä½ åº”è¯¥è¦æ±‚çš„ï¼

æ‰€æœ‰çš„éƒ¨åˆ†éƒ½å¾ˆé‡è¦

æ’ä»¶å…ƒæ•°æ®åœ¨æˆ‘ä»¬çš„æ¨¡æ‹Ÿå™¨ä¸­æœ‰ä¸€äº›ç”¨å¤„ï¼Œä½†å®ƒä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ•™ç¨‹ï¼Œå¯ä»¥æµ‹è¯•å’Œæé«˜æ‚¨å¯¹åº•å±‚ç»“æ„çš„äº†è§£ï¼Œæ¯”å¦‚äº‹ç‰©çš„äºŒè¿›åˆ¶è¡¨ç¤ºã€‚å®ƒä»¥åä¼šæ´¾ä¸Šç”¨åœºçš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç®€å•çš„æ–¹æ³•æ¥ç¼“è§£ä½ çš„æ–¹å¼ã€‚

Python å¯ä»¥å¾ˆå®¹æ˜“åœ°è¡¨ç¤ºä»¿çœŸå™¨æ‰€éœ€çš„è¡¨ç¤ºï¼Œå¹¶åœ¨å®ƒä»¬ä¹‹é—´è¿›è¡Œè½¬æ¢

åå…­è¿›åˆ¶ã€å¤§ç«¯å’Œå°ç«¯ã€äºŒè¿›åˆ¶å’Œä»»ä½•æ•°é‡çš„ç»“æ„åŒ–äºŒè¿›åˆ¶æ ¼å¼éƒ½æ˜¯å¯èƒ½çš„ï¼Œè¿™è¦å½’åŠŸäºè®¸å¤šå…¬è®¤éšè—çš„æ–¹æ³•è°ƒç”¨ã€‚

* 

 *

## Z80 æŒ‡ä»¤è§£ç å™¨å’Œåæ±‡ç¼–ç¨‹åº

 çŸ­æš‚ä½†é‡è¦çš„æ’æ›²ã€‚

åœ¨æ•´ä¸ªè¯¾ç¨‹ä¸­ï¼Œæˆ‘å°† CPU ç§°ä¸º Z80(æˆ– Z80 é£æ ¼),å› ä¸ºå®ƒä¸ Game Boy ä¸­çš„ CPU ç±»ä¼¼ã€‚ä½†å®ƒå¹¶ä¸å®Œå…¨ç›¸åŒ:å®ƒæ˜¯ä¸€æ¬¾ç±»ä¼¼è‹±ç‰¹å°” 8080 çš„å¤æ™® CPUï¼Œåä¸º *LR35902* ã€‚æˆ‘å°†ä½¿ç”¨ Z80 è¿™ä¸ªæœ¯è¯­ï¼Œå°½ç®¡å®ƒä¸æ˜¯ 100%çœŸå®çš„ã€‚åŸå› æ˜¯é™¤äº†æåˆ° Game Boy ä¹‹å¤–ï¼Œäº’è”ç½‘ä¸Šå…³äº Sharp CPU çš„æ–‡æ¡£å¾ˆå°‘ã€‚å¦‚æœä½ æƒ³å‘ç°æ›´å¤šå…³äº CPU çš„æ–‡çŒ®ï¼Œä½ æœ€å¥½çš„é€‰æ‹©æ˜¯æœç´¢ Z80ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ç§éå¸¸å¸¸è§çš„ CPU å‹å·ã€‚è¯·è®°ä½ï¼Œæ“ä½œç å’Œå…¶ä»–ä¸€äº› CPU ç»†èŠ‚ç¡®å®ä¸åŒã€‚ 

äº†è§£äº†å­—èŠ‚åºåˆ—çš„è¡¨ç¤ºå¦‚ä½•ä¾èµ–äºä¸Šä¸‹æ–‡ä¹‹åï¼Œç°åœ¨è®©æˆ‘ä»¬æŠŠæ³¨æ„åŠ›è½¬å‘åæ±‡ç¼–å™¨ã€‚

åœ¨æˆ‘ç»§ç»­ä¹‹å‰æœ‰ä¸€ä¸ªè¦ç‚¹ã€‚CPU ä»¿çœŸå™¨*å®é™…ä¸Š*æ ¹æœ¬ä¸éœ€è¦åæ±‡ç¼–å™¨ï¼›ä½†æ˜¯*ä½ *ä¼šã€‚CPU åªå…³å¿ƒ*ä»å­—èŠ‚æµä¸­è§£ç *æŒ‡ä»¤ï¼Œè€Œä¸å…³å¿ƒåœ¨å±å¹•ä¸Šæ˜¾ç¤ºç»™äººä»¬é˜…è¯»ã€‚ä½†æ˜¯ï¼Œè‰¯å¥½çš„è°ƒè¯•å’Œä»ªå™¨è®¾å¤‡å¯¹äºæˆåŠŸçš„ä»¿çœŸå™¨é¡¹ç›®æ˜¯è‡³å…³é‡è¦çš„ã€‚æœ€å¥½ä»åæ±‡ç¼–ç¨‹åº(å’Œè§£ç å™¨)å¼€å§‹ï¼Œå› ä¸ºä½ æƒ³äº†è§£ CPU å°†è¦æ¨¡æ‹Ÿçš„æŒ‡ä»¤ï¼Œä»¥åŠä¸ºä»€ä¹ˆã€‚

åœ¨ [Game Boy æ¨¡æ‹Ÿå™¨ç®€ä»‹](https://www.inspiredpython.com/course/game-boy-emulator/let-s-write-a-game-boy-emulator-in-python) ä¸­ï¼Œæˆ‘ä»¬è§£æäº†æ“ä½œç æ–‡ä»¶ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªå¯é€‰ä»»åŠ¡æ¥æ‰“å°æ“ä½œç ã€‚ä¸‹ä¸€æ­¥æˆ‘ä»¬å°†éœ€è¦è¿™äº›ç»è¿‡è§£æçš„æ“ä½œç å­—å…¸ã€‚æˆ‘é€‰æ‹©äº†æ•°æ®ç±»ï¼›å®ƒä»¬çœ‹èµ·æ¥æœ‰ç‚¹åƒè¿™æ ·:

```
Instruction(   opcode=0x0, immediate=True, operands=[], cycles=[4], bytes=1, mnemonic="NOP", comment="", )
```

æˆ‘ä»¬éœ€è¦ä¸¤æœ¬è¯´æ˜ä¹¦è¯å…¸ã€‚ä¸€ä¸ªç”¨äº*å‰ç¼€æŒ‡ä»¤*ï¼Œå¦ä¸€ä¸ªç”¨äºå¸¸è§„æŒ‡ä»¤ã€‚æœ‰ä¸¤ä¸ªï¼Œå› ä¸ºä¸å¯èƒ½ç”¨ä¸€ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºæ‰€æœ‰ä¸åŒçš„æŒ‡ä»¤ã€‚å› æ­¤ï¼Œå‰ç¼€æŒ‡ä»¤æ˜¯ï¼Œ*ä»¥`0xCB`ä½œä¸º*çš„å‰ç¼€ï¼Œä»¥å‘ CPU æŒ‡ç¤ºä¹‹åçš„å­—èŠ‚*æ˜¯å‰ç¼€æŒ‡ä»¤ã€‚*

æ‰€ä»¥`CB 26`æœ‰`SLA (HL)`çš„åŠ©è®°ç¬¦ã€‚ä½ å¯ä»¥åœ¨ pandoc ä¸Šçœ‹åˆ°ä¸€ä¸ª [CPU æŒ‡ä»¤é›†](https://gbdev.io/pandocs/CPU_Instruction_Set.html)çš„åˆ—è¡¨ï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨ä½ è§£æè¿‡çš„å­—å…¸ä¸­çœ‹åˆ°ã€‚æˆ‘è¿˜å»ºè®®ä½ éšèº«æºå¸¦[æ¸¸æˆæœº CPU æ‰‹å†Œ](http://marc.rawer.de/Gameboy/Docs/GBCPUman.pdf)ï¼Œå› ä¸ºå®ƒå¯¹ä½¿ç”¨è¯´æ˜æœ‰æ›´è¯¦ç»†çš„è§£é‡Šã€‚

ç°åœ¨æˆ‘ä»¬æœ‰äº†æ“ä½œç åˆ—è¡¨ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å°†å­—èŠ‚æµæ˜ å°„åˆ°å®ƒä»¬çš„æ“ä½œç ç­‰ä»·ç‰©çš„é—®é¢˜äº†ã€‚ç„¶è€Œï¼Œæœ‰å‡ ä¸ªéšœç¢ä½¿å¾—ä½¿ç”¨æˆ‘ä»¬ä¸Šé¢ä½¿ç”¨çš„`struct`æ–¹æ³•ä¸å¯è¡Œ:

æŒ‡ä»¤çš„å­—èŠ‚é•¿åº¦æ˜¯ä¸å›ºå®šçš„

æ¯ä¸ªæŒ‡ä»¤çš„å¤§å°ä»ä¸€ä¸ªå­—èŠ‚åˆ°ä¸¤ä¸ªå­—èŠ‚ä¸ç­‰ã€‚æ‰€æœ‰å¸¦å‰ç¼€çš„æŒ‡ä»¤æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸¤ä¸ªå­—èŠ‚é•¿ã€‚

æ“ä½œç æ˜¯*å¯å˜çš„*

æœ‰äº›æ“ä½œç æœ‰æ“ä½œæ•°ï¼Œæœ‰äº›æ²¡æœ‰ã€‚ä¾‹å¦‚ï¼Œ`0x0` ( `NOP`)æ²¡æœ‰æ“ä½œæ•°ã€‚ä½†æ˜¯`CB 26`æœ‰*ä¸€ä¸ª*ã€‚æœ‰äº›è¿˜å¼•ç”¨ä¸€ä¸ªç‰¹æ®Šçš„å†…å­˜ä½ç½®ï¼Œè¿›ä¸€æ­¥å¢åŠ äº†è¦è¯»å–çš„å­—èŠ‚æ•°ã€‚

æ‚¨è¯»å–çš„åç§»é‡æœªçŸ¥

ä¹Ÿè®¸ä½ æ­£åœ¨ä»`0x0`å¼€å§‹è¯»ï¼Œæˆ–è€…ä¹Ÿè®¸æ˜¯å¦ä¸€ä¸ªåç§»ã€‚

è¯¥æµå¯èƒ½æ˜¯æ— é™çš„

å½“æˆ‘ä»¬åæ±‡ç¼–ç›’å¼ ROM(å®ƒæœ‰å›ºå®šçš„å¤§å°)æ—¶ï¼Œè¿™ç§æƒ…å†µä¸ä¼šå‘ç”Ÿï¼Œä½†æ˜¯ä¸€æ—¦æˆ‘ä»¬çš„ä»¿çœŸå™¨å¼€å§‹æ‰§è¡ŒæŒ‡ä»¤ï¼Œè¿™ç§æƒ…å†µå°±ä¼šå‘ç”Ÿï¼Œè€Œä¸”æˆ‘ä»¬æ²¡æœ‰ç®€å•çš„æ–¹æ³•çŸ¥é“ï¼Œæˆ–è€…  ã€‚

å› æ­¤ï¼Œä½¿ç”¨è§£æçš„æ“ä½œç ä½œä¸ºæˆ‘ä»¬éœ€è¦è¯»å–çš„å†…å®¹çš„æŒ‡å—ï¼Œæ›´å®¹æ˜“è·å–æˆ‘ä»¬æ‰€å­¦çš„çŸ¥è¯†ï¼Œä¸€æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚

æ‰€ä»¥ç›®æ ‡å¤§è‡´æ˜¯:

1.  ç»™å®šä¸€ä¸ªåœ°å€(æƒ³æƒ³å­—èŠ‚æ•°ç»„ä¸­çš„ç´¢å¼•)å’Œæˆ‘ä»¬è§£æè¿‡çš„æ“ä½œç ï¼Œè¯»å–ä¸€ä¸ªå­—èŠ‚å¹¶å°†åœ°å€åŠ  1

2.  å¦‚æœå­—èŠ‚ç­‰äº`0xCB`ï¼Œä½¿ç”¨å‰ç¼€æŒ‡ä»¤æ“ä½œç æŸ¥æ‰¾è¡¨ï¼Œå¹¶å°†åœ°å€é€’å¢ 1ã€‚

3.  ä»æ“ä½œç æŸ¥æ‰¾è¡¨ä¸­è·å–æŒ‡ä»¤

4.  åœ¨æŒ‡ä»¤çš„*æ“ä½œæ•°*ä¸Šå¾ªç¯ï¼Œå¹¶ä¸”:

     1.  å¦‚æœæ“ä½œæ•°æœ‰`bytes > 0`ï¼Œè¯»å–åŒæ ·å¤šçš„å­—èŠ‚ï¼Œå°†åœ°å€é€’å¢ï¼Œå¹¶å°†å…¶å­˜å‚¨ä¸ºæ“ä½œæ•°çš„`value`ã€‚

    2.  å¦‚æœæ˜¯`bytes is None`å­—æ®µï¼Œé‚£ä¹ˆæ“ä½œæ•°ä¸æ˜¯æ•°æ®å€¼ï¼Œè€Œæ˜¯å›ºå®šæ“ä½œæ•°ï¼Œæ‰€ä»¥å°†å…¶å­˜å‚¨åœ¨`name`ä¸­ã€‚ 
5.  æ­¤æ—¶ï¼Œæ‚¨å°†æ‹¥æœ‰ä¸€æ¡æŒ‡ä»¤å’Œç›¸å…³è”çš„æ“ä½œæ•°(å¦‚æœæœ‰çš„è¯)ã€‚è¿”å›åœ°å€å’Œè¯´æ˜ã€‚

6.  ç¡®ä¿æ‚¨è¯»å–çš„ä»»ä½•å€¼éƒ½è¢«è½¬æ¢ä¸ºç³»ç»Ÿçš„ byteorderã€‚ä½¿ç”¨`sys.byteorder`

è¿™ä¸ªç»ƒä¹ çš„ç›®çš„æ˜¯å°†å­—èŠ‚ä¸²ç¿»è¯‘æˆ CPU å’Œæˆ‘ä»¬è¿™äº›å¼€å‘è€…éƒ½èƒ½ç†è§£çš„é«˜çº§æŒ‡ä»¤ã€‚å› ä¸ºå­—èŠ‚é•¿åº¦æ ¹æ®æ“ä½œç è€Œå˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç®€å•åœ°å°†æµåˆ†æˆæŒ‡ä»¤åŒ…æ¥è§£æã€‚

è®©æˆ‘ä»¬ä»æµ‹è¯•`NOP`æŒ‡ä»¤å¼€å§‹:

```
@pytest.fixture def  make_decoder(request):   def  make(data:  bytes, address:  int  =  0): opcode_file = Path(request.config.rootdir)  /  "etc/opcodes.json" return Decoder.create(opcode_file=opcode_file, data=data, address=address) return make   def  test_decoder_nop_instruction(make_decoder):   decoder = make_decoder(data=bytes.fromhex("00")) new_address, instruction = decoder.decode(0x0) assert new_address ==  0x1 assert instruction == Instruction( opcode=0x0, immediate=True, operands=[], cycles=[4], bytes=1, mnemonic="NOP", comment="", )
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä½¿ç”¨ pytest å·¥å‚å¤¹å…·æ¥ç”Ÿæˆ`Decoder`å¯¹è±¡ï¼Œå®ƒå°†å®Œæˆæ‰€æœ‰ç¹é‡çš„å·¥ä½œã€‚ç„¶åï¼Œæµ‹è¯•ç”Ÿæˆä¸€ä¸ªå¸¦å­—èŠ‚ä¸²`\x00`çš„è§£ç å™¨ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘è¦æ±‚è§£ç å™¨è§£ç åœ°å€`0x0`(è¿™å½“ç„¶æ˜¯æˆ‘ä»¬çš„å­—èŠ‚ä¸²ä¸­çš„ç¬¬ä¸€ä¸ªä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªå­—èŠ‚)ï¼Œå¹¶æ–­è¨€è¯¥æŒ‡ä»¤ä¸æˆ‘ä»æˆ‘è§£æçš„æ“ä½œç æ–‡ä»¶ä¸­è·å¾—çš„æŒ‡ä»¤ç›¸åŒ¹é…ï¼Œå¹¶ä¸”è§£ç å™¨è¿”å›çš„åœ°å€åæ˜ äº†æ–°çš„ä½ç½®:`0x1`ã€‚

ç°åœ¨æ˜¯è§£ç å™¨ã€‚è®©æˆ‘ä»¬ä»æ„é€ å‡½æ•°å’Œç±»çš„æ¡†æ¶å¼€å§‹ã€‚

```
@dataclass class  Decoder:   data:  bytes address:  int prefixed_instructions:  dict instructions:  dict   @classmethod def  create(cls, opcode_file: Path, data:  bytes, address:  int  =  0):  prefixed, regular = load_opcodes(opcode_file) return cls( prefixed_instructions=prefixed, instructions=regular, data=data, address=address, )
```

è§£ç å™¨è¦æ±‚`data`è§£ç ã€‚ç¨åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä»¿çœŸå™¨çš„å†…å­˜åº“æ›¿æ¢â€œæ•°æ®â€çš„ä¸€èˆ¬æ¦‚å¿µã€‚ç›®å‰ï¼Œä¸€èˆ¬çš„å­—èŠ‚å­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªä¸é”™çš„æ›¿ä»£å“ã€‚

æˆ‘ä»¬è¿˜å°è£…äº†ä¸€ä¸ª`address`,è¿™æ ·æˆ‘ä»¬ä»¥åå°±å¯ä»¥æŸ¥è¯¢å®ƒæœ€åçš„ä½ç½®ã€‚ç°åœ¨è¿˜ä¸éœ€è¦ï¼Œä½†æ˜¯æœ‰å®ƒåœ¨èº«è¾¹å¾ˆæœ‰ç”¨ã€‚æœ€åï¼Œæœ‰ä¸¤ä¸ªåŒ…å«å·²è§£ææ“ä½œç çš„å­—å…¸ã€‚

`create` classmethod æ˜¯ä¸€ä¸ªå·¥å‚ï¼Œå®ƒè¯»å…¥æ“ä½œç æ–‡ä»¶å¹¶è°ƒç”¨è§£æ JSON æ“ä½œç æ–‡ä»¶çš„`load_opcodes`(æœªæ˜¾ç¤º)ã€‚å®ƒè¿˜éœ€è¦å¦å¤–ä¸¤ä¸ªå‚æ•°æ¥ä¸ºè§£ç å™¨æä¾›æ•°æ®å’Œèµ·å§‹åœ°å€ã€‚

 æ’‡å¼€éšæœºä¸è°ˆ:æˆ‘å»ºè®®ä½ ä¸è¦æŠŠæœ‰å‰¯ä½œç”¨çš„ä»£ç å¡è¿›`__init__`æ„é€ å‡½æ•°ä¸­ï¼Œå› ä¸ºè¿™å‡ ä¹æ€»æ˜¯ä¸€è‚¡ä»£ç å‘³ã€‚å¦‚æœåˆ›å»ºæˆ–ä¸å…¶ä»–äº‹ç‰©å¯¹è¯æ˜¯ç±»çš„å¥‘çº¦çš„ä¸€éƒ¨åˆ†ï¼Œä½ åº”è¯¥æŠŠå®ƒæ”¾åˆ°ä¸€ä¸ª`@classmethod`ä¸­ï¼Œå®ƒä¼šä¸ºä½ åšè¿™ä»¶äº‹ï¼Œå°±åƒæˆ‘åœ¨è¿™é‡Œåšçš„é‚£æ ·ã€‚

ç°åœ¨ï¼Œæ‚¨å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ª`Decoder`çš„å®ä¾‹ï¼Œå¹¶ä¼ é€’ä¼ªé€ çš„å­—å…¸å€¼ï¼Œè€Œä¸å¿…åƒåœ¨`__init__`ä¸­é‚£æ ·ä¿®è¡¥æˆ–åˆ‡æ¢`load_opcodes`è°ƒç”¨ã€‚ 

ç°åœ¨æ˜¯è¿™èŠ‚è¯¾çš„é‡ç‚¹ã€‚è§£ç å™¨æ–¹æ³•æœ¬èº«ã€‚

```
import sys   @dataclass class  Decoder:      def  read(self, address:  int, count:  int  =  1): """ Reads `count` bytes starting from `address`. """ if  0  <= address + count <=  len(self.data): v = self.data[address : address + count] return  int.from_bytes(v, sys.byteorder) else: raise IndexError(f'{address=}+{count=} is out of range')   def  decode(self, address:  int): """ Decodes the instruction at `address`. """ opcode =  None decoded_instruction =  None opcode = self.read(address) address +=  1   if opcode ==  0xCB: opcode = self.read(address) address +=  1 instruction = self.prefixed_instructions[opcode] else: instruction = self.instructions[opcode] new_operands =  [] for operand in instruction.operands: if operand.bytes  is  not  None: value = self.read(address, operand.bytes) address += operand.bytes new_operands.append(operand.copy(value)) else:  new_operands.append(operand) decoded_instruction = instruction.copy(operands=new_operands) return address, decoded_instruction
```

æˆ‘è®¤ä¸º`read`æ–¹æ³•ä¸è¨€è‡ªæ˜ã€‚å¦‚æœæˆ‘ä»¬è¯•å›¾è¯»å–è¶…å‡ºå­—èŠ‚å­—ç¬¦ä¸²çš„ç•Œé™ï¼Œå¼•å‘ä¸€ä¸ª`IndexError`ï¼Œå¦åˆ™ä»`address`è¿”å›`count`å­—èŠ‚æ•°ã€‚

`decode`æ–¹æ³•éµå¾ªæˆ‘åœ¨ä¸Šé¢æå‡ºçš„ç®—æ³•ã€‚æˆ‘ä»¬ä¸€æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œè®°ä½å½“æˆ‘ä»¬è¿™æ ·åšæ—¶é€’å¢`address`ï¼Œå¦‚æœæœ‰ä¸åŒ¹é…æŒ‡ä»¤ç›¸å…³è”çš„æ“ä½œæ•°ï¼Œæˆ‘ä»¬è¯»å–ä¸€ä¸ªé¢å¤–çš„`operand.bytes`(å†æ¬¡é€’å¢åœ°å€)å¹¶å°†å…¶å­˜å‚¨åœ¨`operand.value`ä¸­ã€‚å¦‚æœ`operand.bytes is None`æˆ‘ä»¬åªæ˜¯æŒ‰åŸæ ·å­˜å‚¨æ“ä½œæ•°ã€‚

 è¿›è¡Œ`bytes is not None`æ£€æŸ¥çš„åŸå› ä¸ JSON æ–‡ä»¶ä¸­æ“ä½œç è¡¨çš„å¸ƒå±€æœ‰å…³ã€‚å¹¶éæ‰€æœ‰æ“ä½œæ•°éƒ½æ˜¯å‚æ•°åŒ–çš„ï¼Œéœ€è¦é¢å¤–çš„å­—èŠ‚æ¥è¯»å–ã€‚å¦‚æœä»–ä»¬æ²¡æœ‰å­—èŠ‚è¦è¯»ï¼Œæˆ‘ä»¬*ä»ç„¶*æƒ³è¦æ“ä½œæ•°ã€‚ 

ä¸¤ä¸ªæŒ‡ä»¤å­—å…¸éƒ½åŒ…å«æˆ‘åœ¨ [æŒ‡ä»¤å’Œæ“ä½œæ•°æ•°æ®ç±»](https://www.inspiredpython.com/course/game-boy-emulator/let-s-write-a-game-boy-emulator-in-python#instruction-and-operand-dataclasses) ä¸­å®šä¹‰çš„`Instruction`æ•°æ®ç±»çš„å®ä¾‹ã€‚å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯è¿”å›`Instruction`æˆ–`Operand`å®ä¾‹çš„ç›¸åŒå‰¯æœ¬çš„`copy`æ–¹æ³•ï¼Œä½†æ˜¯äº¤æ¢å‡ºäº†`value`(ç”¨äº`Operand`)æˆ–`operands`(ç”¨äº`Instruction`)ã€‚

æˆ‘è¿˜ä¸º`Operand`å’Œ`Instruction`ç±»æ·»åŠ äº†ä¸€äº›æ¼‚äº®çš„æ‰“å°æœº:

```
@dataclass class  Operand:      def  print(self): if self.adjust is  None: adjust =  "" else: adjust = self.adjust if self.value is  not  None: if self.bytes  is  not  None: val =  hex(self.value) else: val = self.value v = val else: v = self.name v = v + adjust if self.immediate: return v return  f'({v})'   @dataclass class  Instruction:      def  print(self): ops =  ', '.join(op.print()  for op in self.operands) s =  f"{self.mnemonic:<8}  {ops}" if self.comment: s = s +  f" ; {self.comment:<10}" return s
```

æ‰“å°æœºä»£ç ä¸è¨€è‡ªæ˜ã€‚ç›®æ ‡æ˜¯æ ¼å¼åŒ–ä¸€æ¡æŒ‡ä»¤(å’Œä»»ä½•æ“ä½œæ•°)çœ‹èµ·æ¥åƒæ‰‹å†™çš„æ±‡ç¼–ä»£ç ã€‚å®ƒæœ‰ä¸€ç§é£æ ¼ï¼Œä½ å¯ä»¥çœ‹åˆ°å®ƒåœ¨æ‰€æœ‰çš„ Game Boy å’Œ Z80 æ±‡ç¼–è¯­è¨€æ‰‹å†Œä¸­æˆ–å¤šæˆ–å°‘æ˜¯ç›¸åŒçš„ã€‚

æœ‰äº†æ¼‚äº®çš„æ‰“å°æœºå’Œå¯ç”¨çš„è§£ç å™¨ï¼Œæˆ‘ä»¬å°±å¿«å®Œæˆäº†:

```
>>> dec = Decoder.create(opcode_file=opcode_file, data=Path('bin/snake.gb').read_bytes(), address=0) >>> _, instruction = dec.decode(0x201) >>> instruction Instruction(opcode=224, immediate=False, operands=[   Operand(immediate=False, name='a8',  bytes=1, value=139, adjust=None), Operand(immediate=True, name='A',  bytes=None, value=None, adjust=None) ], cycles=[12],  bytes=2, mnemonic='LDH', comment='') >>> instruction.print() 'LDH      (0x8b), A'
```

ç°åœ¨å¾ˆå®¹æ˜“å°†å…¶æ¨å¹¿åˆ°èƒ½å¤Ÿåˆ†è§£ä»»æ„é•¿åº¦å­—èŠ‚çš„å‡½æ•°:

```
def  disassemble(decoder: Decoder, address:  int, count:  int):   for _ in  range(count): try: new_address, instruction = decoder.decode(address) pp = instruction.print() print(f'{address:>04X}  {pp}') address = new_address except IndexError as e: print('ERROR - {e!s}') break
```

å½“ä»¥åç§»é‡`0x150`(æ°å¥½æ˜¯`snake.gb`çš„å…¥å£ç‚¹)è¿è¡Œæ—¶:

```
>>> disassemble(dec, 0x150, 16) 0150 NOP 0151 DI 0152 LD       SP, 0xfffe 0155 LD       B, 0x80 0157 LD       C, 0x0 0159 LDH      A, (0x44) 015B CP       0x90 015D JR       NZ, 0xfa 015F DEC      C 0160 LD       A, C 0161 LDH      (0x42), A 0163 DEC      B 0164 JR       NZ, 0xf3 0166 XOR      A 0167 LDH      (0x40), A 0169 LD       A, 0x0 
```

ä»…æ­¤è€Œå·²ã€‚æ­£åœ¨å·¥ä½œçš„æ‹†å¸å™¨ã€‚åƒ Ghidra å’Œ IDA Pro è¿™æ ·çš„é«˜çº§å·¥å…·é™„å¸¦äº†ä¸€ç³»åˆ—é™„åŠ åŠŸèƒ½ï¼Œæ¯”å¦‚è®¡ç®—è°ƒç”¨å›¾ã€å‡½æ•°å¼€å§‹å’Œç»“æŸçš„ä½ç½®ç­‰ç­‰ã€‚ä½†æ˜¯è¿™è¶³ä»¥è®©æˆ‘ä»¬*å¼€å§‹ç†è§£*æˆ‘ä»¬æœªæ¥çš„ä»¿çœŸå™¨ CPU æ­£åœ¨æ‰§è¡Œä»€ä¹ˆã€‚

æˆ‘ä»¬ç°åœ¨å‡†å¤‡å¤„ç†ç­‰å¼çš„ä¸‹ä¸€éƒ¨åˆ†:ç¼–å†™æ„æˆ CPU çš„æ¡†æ¶ï¼›CPU å¯„å­˜å™¨(ä»¥åŠå®ƒä»¬æ˜¯ä»€ä¹ˆ)ï¼›å’Œä¸€ä¸ª Z80 æ±‡ç¼–è¯­è¨€é€Ÿæˆç­æ¥å¸®åŠ©æˆ‘ä»¬å…¥é—¨ã€‚

*